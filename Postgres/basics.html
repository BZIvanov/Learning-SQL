<!DOCTYPE html>
<html lang="en">
  <head>
    <style>
      * {
        font-family: sans-serif;
      }
      body {
        font-size: 14px;
      }
      h3,
      p,
      ul {
        margin: 0;
      }
      section {
        margin: 20px 0;
        padding: 5px;
        box-shadow: 0 0 9px #d48dd4;
        border-radius: 3px;
      }
      section > div {
        margin: 5px 0;
      }
      .query {
        background-color: #dbdccf;
        padding: 7px 5px;
      }
      .query pre {
        margin: 0;
      }
      table {
        border-collapse: collapse;
      }
      th,
      td {
        border: 1px solid #723457;
        padding: 2px;
      }
      sup {
        color: #454545;
      }
      th[colspan] {
        color: #723457;
      }
      .source-table {
        display: flex;
      }
      .source-table table {
        margin-right: 7px;
      }
    </style>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Postgresql</title>
  </head>
  <body>
    <section>
      <div class="title">
        <h3>Skip and limit results</h3>
      </div>
      <div class="info">
        <ul>
          <li>Useful for example for pagination.</li>
        </ul>
      </div>
      <div class="source-table">
        <table>
          <thead>
            <tr>
              <th>name</th>
              <th>city</th>
              <th>income</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Angelina</td>
              <td>Sofia</td>
              <td>5000</td>
            </tr>
            <tr>
              <td>Valeria</td>
              <td>Sofia</td>
              <td>5200</td>
            </tr>
            <tr>
              <td>Evgeni</td>
              <td>Plovdiv</td>
              <td>4250</td>
            </tr>
            <tr>
              <td>Traqn</td>
              <td>Plovdiv</td>
              <td>4900</td>
            </tr>
            <tr>
              <td>Eli</td>
              <td>Varna</td>
              <td>4990</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="query">
        <pre>
<b>SELECT</b> * <b>FROM</b> people
<b>ORDER BY</b> income <b>LIMIT</b> 2 <b>OFFSET</b> 2;
</pre>
      </div>
      <div class="result-table">
        <table>
          <thead>
            <tr>
              <th>name</th>
              <th>city</th>
              <th>income</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Eli</td>
              <td>Varna</td>
              <td>4990</td>
            </tr>
            <tr>
              <td>Angelina</td>
              <td>Sofia</td>
              <td>5000</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

    <section>
      <div class="title">
        <h3>Union reesults</h3>
      </div>
      <div class="info">
        <ul>
          <li>Useful for combining the result of different queries.</li>
          <li>Both queries must produce similar column structure.</li>
          <li>
            Without union all, just union we would get 3 results, because
            duplicates are ignored.
          </li>
          <li>
            if we use <b>INTERSECT</b> instead of <b>UNION</b> we would get only
            common results for both queries.
          </li>
          <li>
            if we use <b>EXCEPT</b> instead of <b>UNION</b> we would get the
            results from the first query except the results returned from the
            second query. Basically everything present in the first query except
            the second.
          </li>
        </ul>
      </div>
      <div class="source-table">
        <table>
          <thead>
            <tr>
              <th>name</th>
              <th>income</th>
              <th>taxes</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Angelina</td>
              <td>5000</td>
              <td>350.50</td>
            </tr>
            <tr>
              <td>Valeria</td>
              <td>5200</td>
              <td>220</td>
            </tr>
            <tr>
              <td>Evgeni</td>
              <td>4250</td>
              <td>160</td>
            </tr>
            <tr>
              <td>Traqn</td>
              <td>4900</td>
              <td>190</td>
            </tr>
            <tr>
              <td>Eli</td>
              <td>4990</td>
              <td>90</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="query">
        <pre>
(<b>SELECT</b> * <b>FROM</b> people <b>ORDER BY</b> income <b>DESC LIMIT</b> 2)
<b>UNION ALL</b>
(<b>SELECT</b> * <b>FROM</b> people <b>ORDER BY</b> income - taxes <b>DESC LIMIT</b> 2);
</pre>
      </div>
      <div class="result-table">
        <table>
          <thead>
            <tr>
              <th>name</th>
              <th>income</th>
              <th>taxes</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Valeria</td>
              <td>5200</td>
              <td>220</td>
            </tr>
            <tr>
              <td>Angelina</td>
              <td>5000</td>
              <td>350.50</td>
            </tr>
            <tr>
              <td>Valeria</td>
              <td>5200</td>
              <td>220</td>
            </tr>
            <tr>
              <td>Eli</td>
              <td>4990</td>
              <td>90</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

    <section>
      <div class="title">
        <h3>Sub queries</h3>
      </div>
      <div class="info">
        <ul>
          <li>
            With sub queries we can use the result of one query in another.
          </li>
          <li>
            Very <b>important</b> note here is to understand the returned type
            of the subquery. It is not table with one or many columns and rows.
            It is scalar type, single value which we can reuse. Basically,
            because the result is one column and one row.
          </li>
        </ul>
      </div>
      <div class="source-table">
        <table>
          <thead>
            <tr>
              <th>name</th>
              <th>income</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Angelina</td>
              <td>5000</td>
            </tr>
            <tr>
              <td>Valeria</td>
              <td>5200</td>
            </tr>
            <tr>
              <td>Evgeni</td>
              <td>4250</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="query">
        <pre>
<b>SELECT</b> * <b>FROM</b> people <b>WHERE</b> income &gt; (
  <b>SELECT</b> income <b>FROM</b> people <b>WHERE</b> name = 'Angelina'
);
</pre>
      </div>
      <div class="result-table">
        <table>
          <thead>
            <tr>
              <th>name</th>
              <th>income</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Valeria</td>
              <td>5200</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

    <section>
      <div class="title">
        <h3>Sub queries in the select clause.</h3>
      </div>
      <div class="info">
        <ul>
          <li>
            For our custom column we will have value calculated with the scalar
            result returned by the subquery.
          </li>
        </ul>
      </div>
      <div class="source-table">
        <table>
          <thead>
            <tr>
              <th>name</th>
              <th>income</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Angelina</td>
              <td>5000</td>
            </tr>
            <tr>
              <td>Valeria</td>
              <td>5200</td>
            </tr>
            <tr>
              <td>Evgeni</td>
              <td>4250</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="query">
        <pre>
<b>SELECT</b> name, income, income / (<b>SELECT</b> <b>max</b>(income) <b>FROM</b> people) <b>AS</b> ratio
<b>FROM</b> people <b>ORDER BY</b> income <b>DESC</b>;
</pre>
      </div>
      <div class="result-table">
        <table>
          <thead>
            <tr>
              <th>name</th>
              <th>income</th>
              <th>ratio</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Valeria</td>
              <td>5200</td>
              <td>1.00000000000000000000</td>
            </tr>
            <tr>
              <td>Angelina</td>
              <td>5000</td>
              <td>0.96153846153846153846</td>
            </tr>
            <tr>
              <td>Evgeni</td>
              <td>4250</td>
              <td>0.81730769230769230769</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

    <section>
      <div class="title">
        <h3>Sub queries in the from clause.</h3>
      </div>
      <div class="info">
        <ul>
          <li>We are required to use alias AS c even if we don't use it.</li>
          <li>
            Outside the subquery, we can only use columns from the subquery.
          </li>
        </ul>
      </div>
      <div class="source-table">
        <table>
          <thead>
            <tr>
              <th>name</th>
              <th>city</th>
              <th>income</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Mira</td>
              <td>Sofia</td>
              <td>4500</td>
            </tr>
            <tr>
              <td>Iva</td>
              <td>Plovdiv</td>
              <td>5100</td>
            </tr>
            <tr>
              <td>Tina</td>
              <td>Plovdiv</td>
              <td>4750</td>
            </tr>
            <tr>
              <td>Ivan</td>
              <td>Sofia</td>
              <td>5500</td>
            </tr>
            <tr>
              <td>Deni</td>
              <td>Sofia</td>
              <td>4900</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="query">
        <pre>
<b>SELECT</b> <b>avg</b>(c.cities_count)
<b>FROM</b> (
  <b>SELECT</b> city, <b>COUNT</b>(*) <b>AS</b> cities_count
  <b>FROM</b> people <b>GROUP BY</b> city
) <b>AS</b> c;
</pre>
      </div>
      <div class="result-table">
        <table>
          <thead>
            <tr>
              <th>avg</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>2.5000000000000000</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

    <section>
      <div class="title">
        <h3>Sub queries with join.</h3>
      </div>
      <div class="info">
        <ul>
          <li>We will get users who purchased rice</li>
        </ul>
      </div>
      <div class="source-table">
        <table>
          <thead>
            <tr>
              <th colspan="2">users</th>
            </tr>
            <tr>
              <th>id<sup>PK</sup></th>
              <th>name</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>1</td>
              <td>Mira</td>
            </tr>
            <tr>
              <td>2</td>
              <td>Iva</td>
            </tr>
            <tr>
              <td>3</td>
              <td>Tanq</td>
            </tr>
            <tr>
              <td>4</td>
              <td>Misho</td>
            </tr>
          </tbody>
        </table>
        <table>
          <thead>
            <tr>
              <th colspan="2">products</th>
            </tr>
            <tr>
              <th>id<sup>PK</sup></th>
              <th>product_name</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>1</td>
              <td>Sugar</td>
            </tr>
            <tr>
              <td>2</td>
              <td>Rice</td>
            </tr>
            <tr>
              <td>3</td>
              <td>Milk</td>
            </tr>
          </tbody>
        </table>
        <table>
          <thead>
            <tr>
              <th colspan="3">purchases</th>
            </tr>
            <tr>
              <th>id<sup>PK</sup></th>
              <th>user_id<sup>FK</sup></th>
              <th>product_id<sup>FK</sup></th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>1</td>
              <td>1</td>
              <td>1</td>
            </tr>
            <tr>
              <td>2</td>
              <td>1</td>
              <td>3</td>
            </tr>
            <tr>
              <td>3</td>
              <td>2</td>
              <td>2</td>
            </tr>
            <tr>
              <td>4</td>
              <td>3</td>
              <td>1</td>
            </tr>
            <tr>
              <td>5</td>
              <td>3</td>
              <td>2</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="query">
        <pre>
<b>SELECT</b> name <b>FROM</b> users
<b>INNER JOIN</b> (
  <b>SELECT</b> user_id <b>FROM</b> purchases <b>WHERE</b> product_id = 2
) <b>AS</b> p <b>ON</b> p.user_id = users.id;
</pre>
      </div>
      <div class="result-table">
        <table>
          <thead>
            <tr>
              <th>name</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Iva</td>
            </tr>
            <tr>
              <td>Tanq</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

    <section>
      <div class="title">
        <h3>Sub queries in where clause.</h3>
      </div>
      <div class="info">
        <ul>
          <li>
            Inner select will return 1 column only so we can use it as array of
            values.
          </li>
        </ul>
      </div>
      <div class="source-table">
        <table>
          <thead>
            <tr>
              <th colspan="2">users</th>
            </tr>
            <tr>
              <th>id<sup>PK</sup></th>
              <th>name</th>
              <th>income</th>
              <th>taxes</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>1</td>
              <td>Mira</td>
              <td>5200</td>
              <td>700</td>
            </tr>
            <tr>
              <td>2</td>
              <td>Iva</td>
              <td>5100</td>
              <td>900</td>
            </tr>
            <tr>
              <td>3</td>
              <td>Tanq</td>
              <td>5500</td>
              <td>1100</td>
            </tr>
            <tr>
              <td>4</td>
              <td>Misho</td>
              <td>4900</td>
              <td>900</td>
            </tr>
          </tbody>
        </table>
        <table>
          <thead>
            <tr>
              <th colspan="3">purchases</th>
            </tr>
            <tr>
              <th>id<sup>PK</sup></th>
              <th>user_id<sup>FK</sup></th>
              <th>product_id<sup>FK</sup></th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>1</td>
              <td>1</td>
              <td>1</td>
            </tr>
            <tr>
              <td>2</td>
              <td>1</td>
              <td>3</td>
            </tr>
            <tr>
              <td>3</td>
              <td>2</td>
              <td>2</td>
            </tr>
            <tr>
              <td>4</td>
              <td>3</td>
              <td>1</td>
            </tr>
            <tr>
              <td>5</td>
              <td>3</td>
              <td>2</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="query">
        <pre>
<b>SELECT</b> id <b>FROM</b> purchases <b>WHERE</b> user_id <b>IN</b> (
  <b>SELECT</b> id <b>FROM</b> users <b>WHERE</b> income - taxes &gt; 4300
);
</pre>
      </div>
      <div class="result-table">
        <table>
          <thead>
            <tr>
              <th>id</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>1</td>
            </tr>
            <tr>
              <td>2</td>
            </tr>
            <tr>
              <td>4</td>
            </tr>
            <tr>
              <td>5</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

    <section>
      <div class="title">
        <h3>Another subquery example.</h3>
      </div>
      <div class="info">
        <ul>
          <li>
            With ALL we will select onlyy users which have income higher than
            anyone from Plovdiv.
          </li>
          <li>
            With similar syntax with using SOME we can also achieve filtering
            behaviour.
          </li>
        </ul>
      </div>
      <div class="source-table">
        <table>
          <thead>
            <tr>
              <th>name</th>
              <th>city</th>
              <th>income</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Mira</td>
              <td>Sofia</td>
              <td>5200</td>
            </tr>
            <tr>
              <td>Iva</td>
              <td>Plovdiv</td>
              <td>5100</td>
            </tr>
            <tr>
              <td>Tanq</td>
              <td>Sofia</td>
              <td>5500</td>
            </tr>
            <tr>
              <td>Misho</td>
              <td>Sofia</td>
              <td>4900</td>
            </tr>
            <tr>
              <td>Zaro</td>
              <td>Plovdiv</td>
              <td>5000</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="query">
        <pre>
<b>SELECT</b> * <b>FROM</b> users <b>WHERE</b> income &gt; <b>ALL</b> (
  <b>SELECT</b> income <b>FROM</b> users <b>WHERE</b> city = 'Plovdiv'
);
</pre>
      </div>
      <div class="result-table">
        <table>
          <thead>
            <tr>
              <th>name</th>
              <th>city</th>
              <th>income</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Mira</td>
              <td>Sofia</td>
              <td>5200</td>
            </tr>
            <tr>
              <td>Tanq</td>
              <td>Sofia</td>
              <td>5500</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

    <section>
      <div class="title">
        <h3>Select unique values</h3>
      </div>
      <div class="info">
        <ul>
          <li>
            We will count all unique values, without count we would get once
            Sofia and once Plovdiv.
          </li>
        </ul>
      </div>
      <div class="source-table">
        <table>
          <thead>
            <tr>
              <th>name</th>
              <th>city</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Mira</td>
              <td>Sofia</td>
            </tr>
            <tr>
              <td>Iva</td>
              <td>Plovdiv</td>
            </tr>
            <tr>
              <td>Tanq</td>
              <td>Sofia</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="query">
        <pre>
<b>SELECT</b> <b>COUNT(DISTINCT</b> city) <b>FROM</b> users;
</pre>
      </div>
      <div class="result-table">
        <table>
          <thead>
            <tr>
              <th>count</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>2</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

    <section>
      <div class="title">
        <h3>Switch case</h3>
      </div>
      <div class="info">
        <ul>
          <li>With Case we can get conditional value.</li>
        </ul>
      </div>
      <div class="source-table">
        <table>
          <thead>
            <tr>
              <th>name</th>
              <th>city</th>
              <th>income</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Mira</td>
              <td>Sofia</td>
              <td>5200</td>
            </tr>
            <tr>
              <td>Iva</td>
              <td>Plovdiv</td>
              <td>5100</td>
            </tr>
            <tr>
              <td>Tanq</td>
              <td>Sofia</td>
              <td>5500</td>
            </tr>
            <tr>
              <td>Misho</td>
              <td>Sofia</td>
              <td>4900</td>
            </tr>
            <tr>
              <td>Zaro</td>
              <td>Plovdiv</td>
              <td>5000</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="query">
        <pre>
<b>SELECT</b> name,
  <b>CASE</b>
    <b>WHEN</b> income &lt; 5000 <b>THEN</b> 'low'
    <b>WHEN</b> income &lt; 5500 <b>THEN</b> 'average'
    <b>ELSE</b> 'high'
  <b>END AS</b> formatted_income
<b>FROM</b> users;
</pre>
      </div>
      <div class="result-table">
        <table>
          <thead>
            <tr>
              <th>name</th>
              <th>formatted_income</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Mira</td>
              <td>average</td>
            </tr>
            <tr>
              <td>Iva</td>
              <td>average</td>
            </tr>
            <tr>
              <td>Tanq</td>
              <td>high</td>
            </tr>
            <tr>
              <td>Misho</td>
              <td>low</td>
            </tr>
            <tr>
              <td>Zaro</td>
              <td>average</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

    <section>
      <div class="title">
        <h3>Insights</h3>
      </div>
      <div class="info">
        <ul>
          <li>
            With the following query we can get info of how our query was
            processed.
          </li>
          <li>For example we can see the execution time of our query.</li>
        </ul>
      </div>
      <div class="source-table">
        <table>
          <thead>
            <tr>
              <th>id</th>
              <th>name</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>1</td>
              <td>Eli</td>
            </tr>
            <tr>
              <td>2</td>
              <td>Mira</td>
            </tr>
            <tr>
              <td>3</td>
              <td>Toni</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="query">
        <pre>
<b>EXPLAIN ANALYZE SELECT</b> * <b>FROM</b> users <b>WHERE</b> name = 'Eli';
</pre>
      </div>
    </section>

    <section>
      <div class="title">
        <h3>Transaction</h3>
      </div>
      <div class="info">
        <ul>
          <li>
            Transaction are usefull for operations requiring multiple queries
            depending on each other. If one of the queries for example fail we
            might want to cancel all the other queries.
          </li>
          <li>
            BEGIN will begin the transaction duplicating imaginary database on
            which we can run commands and the changes will be applied once we
            commit them.
          </li>
          <li>
            In pgAdmin if you open 2 query windows and running transaction on
            the first window, in the 2nd window you will see the changes applied
            once commited.
          </li>
          <li>
            Because the point of transactions is to remove the effect of the
            queries in case of error, we do that with the key word ROLLBACK. It
            will revert all the queries in the transaction(remove our imaginary
            database).
          </li>
          <li>
            In terms of syntax we can use either BEGIN or BEGIN TRANSACTION
          </li>
        </ul>
      </div>
      <div class="source-table">
        <table>
          <thead>
            <tr>
              <th>id</th>
              <th>name</th>
              <th>amount</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>1</td>
              <td>Eli</td>
              <td>200</td>
            </tr>
            <tr>
              <td>2</td>
              <td>Iva</td>
              <td>100</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="query">
        <pre>
<b>BEGIN</b>;
<b>UPDATE</b> people <b>SET</b> amount = amount - 50 <b>WHERE</b> name = 'Eli';
<b>UPDATE</b> people <b>SET</b> amount = amount + 50 <b>WHERE</b> name = 'Iva';
<b>COMMIT</b>;
</pre>
      </div>
      <div class="result-table">
        <table>
          <thead>
            <tr>
              <th>id</th>
              <th>name</th>
              <th>amount</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>1</td>
              <td>Eli</td>
              <td>150</td>
            </tr>
            <tr>
              <td>2</td>
              <td>Iva</td>
              <td>150</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
  </body>
</html>
